import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Car, Search, Loader2, CheckCircle2, AlertCircle } from "lucide-react";
import { base44 } from "@/api/base44Client";

export default function AddVehicleDialog({ open, onClose, onSave, canAddVehicle = true }) {
  const [step, setStep] = useState("vin"); // vin, confirm, manual
  const [vin, setVin] = useState("");
  const [decoding, setDecoding] = useState(false);
  const [decodedData, setDecodedData] = useState(null);
  const [decodeError, setDecodeError] = useState(null);
  const [formData, setFormData] = useState({
    vin: "",
    make: "",
    model: "",
    year: "",
    trim: "",
    engine_type: "",
    transmission: "",
    color: "",
    current_mileage: "",
    license_plate: "",
    purchase_date: "",
    warranty_expiration: ""
  });
  const [saving, setSaving] = useState(false);

  const decodeVin = async () => {
    if (vin.length !== 17) {
      setDecodeError("VIN must be 17 characters");
      return;
    }
    
    setDecoding(true);
    setDecodeError(null);
    
    const response = await base44.integrations.Core.InvokeLLM({
      prompt: `Decode this VIN number and provide vehicle information: ${vin}. Return the make, model, year, trim level, engine type, and transmission type if possible.`,
      add_context_from_internet: true,
      response_json_schema: {
        type: "object",
        properties: {
          make: { type: "string" },
          model: { type: "string" },
          year: { type: "number" },
          trim: { type: "string" },
          engine_type: { type: "string" },
          transmission: { type: "string" },
          valid: { type: "boolean" }
        }
      }
    });
    
    setDecoding(false);
    
    if (response.valid && response.make && response.model && response.year) {
      setDecodedData(response);
      setFormData({
        ...formData,
        vin: vin.toUpperCase(),
        make: response.make,
        model: response.model,
        year: response.year,
        trim: response.trim || "",
        engine_type: response.engine_type || "",
        transmission: response.transmission?.toLowerCase() || ""
      });
      setStep("confirm");
    } else {
      setDecodeError("Could not decode VIN. Please enter vehicle details manually.");
      setFormData({ ...formData, vin: vin.toUpperCase() });
      setStep("manual");
    }
  };

  const handleSubmit = async () => {
    if (!formData.make || !formData.model || !formData.year) return;
    
    setSaving(true);
    
    const vehicleData = {
      vin: formData.vin || undefined,
      make: formData.make,
      model: formData.model,
      year: Number(formData.year),
      trim: formData.trim || undefined,
      engine_type: formData.engine_type || undefined,
      transmission: formData.transmission || undefined,
      color: formData.color || undefined,
      current_mileage: formData.current_mileage ? Number(formData.current_mileage) : undefined,
      license_plate: formData.license_plate || undefined,
      purchase_date: formData.purchase_date || undefined,
      warranty_expiration: formData.warranty_expiration || undefined,
      is_active: true
    };
    
    await onSave(vehicleData);
    setSaving(false);
    handleClose();
  };

  const handleClose = () => {
    setStep("vin");
    setVin("");
    setDecodedData(null);
    setDecodeError(null);
    setFormData({
      vin: "",
      make: "",
      model: "",
      year: "",
      trim: "",
      engine_type: "",
      transmission: "",
      color: "",
      current_mileage: "",
      license_plate: "",
      purchase_date: "",
      warranty_expiration: ""
    });
    onClose();
  };

  if (!canAddVehicle) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <AlertCircle className="w-5 h-5 text-orange-500" />
              Vehicle Limit Reached
            </DialogTitle>
            <DialogDescription>
              Free accounts can only have one vehicle. Upgrade to add unlimited vehicles.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Button className="w-full bg-blue-600 hover:bg-blue-700">
              Upgrade to Premium
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-lg max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Car className="w-5 h-5 text-blue-600" />
            Add Vehicle
          </DialogTitle>
          <DialogDescription>
            {step === "vin" && "Enter your VIN to automatically decode vehicle information"}
            {step === "confirm" && "Confirm your vehicle details"}
            {step === "manual" && "Enter your vehicle details manually"}
          </DialogDescription>
        </DialogHeader>
        
        {step === "vin" && (
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>VIN (Vehicle Identification Number)</Label>
              <div className="flex gap-2">
                <Input
                  placeholder="Enter 17-character VIN"
                  value={vin}
                  onChange={(e) => setVin(e.target.value.toUpperCase())}
                  maxLength={17}
                  className="font-mono"
                />
                <Button 
                  onClick={decodeVin} 
                  disabled={vin.length < 17 || decoding}
                  className="bg-blue-600 hover:bg-blue-700"
                >
                  {decoding ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Search className="w-4 h-4" />
                  )}
                </Button>
              </div>
              <p className="text-xs text-slate-500">{vin.length}/17 characters</p>
              {decodeError && (
                <p className="text-sm text-red-500">{decodeError}</p>
              )}
            </div>
            
            <div className="text-center py-2">
              <button 
                className="text-sm text-blue-600 hover:underline"
                onClick={() => setStep("manual")}
              >
                Don't have a VIN? Enter details manually
              </button>
            </div>
          </div>
        )}

        {step === "confirm" && decodedData && (
          <div className="space-y-4 py-4">
            <div className="bg-green-50 border border-green-200 rounded-xl p-4 flex items-start gap-3">
              <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
              <div>
                <p className="font-medium text-green-800">VIN Decoded Successfully</p>
                <p className="text-sm text-green-700">
                  {decodedData.year} {decodedData.make} {decodedData.model}
                  {decodedData.trim && ` ${decodedData.trim}`}
                </p>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Make</Label>
                <Input value={formData.make} onChange={(e) => setFormData({...formData, make: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Model</Label>
                <Input value={formData.model} onChange={(e) => setFormData({...formData, model: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Year</Label>
                <Input type="number" value={formData.year} onChange={(e) => setFormData({...formData, year: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Trim</Label>
                <Input value={formData.trim} onChange={(e) => setFormData({...formData, trim: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Current Mileage</Label>
                <Input type="number" placeholder="e.g., 45000" value={formData.current_mileage} onChange={(e) => setFormData({...formData, current_mileage: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Color</Label>
                <Input placeholder="e.g., Silver" value={formData.color} onChange={(e) => setFormData({...formData, color: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Purchase Date</Label>
                <Input type="date" value={formData.purchase_date} onChange={(e) => setFormData({...formData, purchase_date: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Warranty Expiration</Label>
                <Input type="date" value={formData.warranty_expiration} onChange={(e) => setFormData({...formData, warranty_expiration: e.target.value})} />
              </div>
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button variant="outline" onClick={() => setStep("vin")}>Back</Button>
              <Button 
                onClick={handleSubmit} 
                disabled={saving}
                className="bg-blue-600 hover:bg-blue-700"
              >
                {saving ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Adding...
                  </>
                ) : (
                  "Add Vehicle"
                )}
              </Button>
            </div>
          </div>
        )}

        {step === "manual" && (
          <div className="space-y-4 py-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Make *</Label>
                <Input placeholder="e.g., Toyota" value={formData.make} onChange={(e) => setFormData({...formData, make: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Model *</Label>
                <Input placeholder="e.g., Camry" value={formData.model} onChange={(e) => setFormData({...formData, model: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Year *</Label>
                <Input type="number" placeholder="e.g., 2020" value={formData.year} onChange={(e) => setFormData({...formData, year: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Trim</Label>
                <Input placeholder="e.g., XLE" value={formData.trim} onChange={(e) => setFormData({...formData, trim: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>VIN</Label>
                <Input placeholder="17 characters" value={formData.vin} onChange={(e) => setFormData({...formData, vin: e.target.value.toUpperCase()})} maxLength={17} className="font-mono" />
              </div>
              <div className="space-y-2">
                <Label>Transmission</Label>
                <Select value={formData.transmission} onValueChange={(value) => setFormData({...formData, transmission: value})}>
                  <SelectTrigger>
                    <SelectValue placeholder="Select" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="automatic">Automatic</SelectItem>
                    <SelectItem value="manual">Manual</SelectItem>
                    <SelectItem value="cvt">CVT</SelectItem>
                    <SelectItem value="other">Other</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Current Mileage</Label>
                <Input type="number" placeholder="e.g., 45000" value={formData.current_mileage} onChange={(e) => setFormData({...formData, current_mileage: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Color</Label>
                <Input placeholder="e.g., Silver" value={formData.color} onChange={(e) => setFormData({...formData, color: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Purchase Date</Label>
                <Input type="date" value={formData.purchase_date} onChange={(e) => setFormData({...formData, purchase_date: e.target.value})} />
              </div>
              <div className="space-y-2">
                <Label>Warranty Expiration</Label>
                <Input type="date" value={formData.warranty_expiration} onChange={(e) => setFormData({...formData, warranty_expiration: e.target.value})} />
              </div>
            </div>

            <div className="flex justify-end gap-3 pt-4">
              <Button variant="outline" onClick={() => setStep("vin")}>Back</Button>
              <Button 
                onClick={handleSubmit} 
                disabled={!formData.make || !formData.model || !formData.year || saving}
                className="bg-blue-600 hover:bg-blue-700"
              >
                {saving ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Adding...
                  </>
                ) : (
                  "Add Vehicle"
                )}
              </Button>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}