import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Bell, Calendar, Gauge, AlertTriangle } from "lucide-react";
import { format, differenceInDays } from "date-fns";
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function UpcomingRemindersWidget({ reminders, vehicles }) {
  const vehicleMap = {};
  vehicles.forEach(v => vehicleMap[v.id] = v);

  const enrichedReminders = reminders
    .map(r => {
      const vehicle = vehicleMap[r.vehicle_id];
      if (!vehicle) return null;

      let urgency = 'normal';
      let daysUntil = null;
      let mileageUntil = null;

      if (r.next_due_date) {
        daysUntil = differenceInDays(new Date(r.next_due_date), new Date());
        if (daysUntil < 0) urgency = 'overdue';
        else if (daysUntil <= 7) urgency = 'urgent';
      }

      if (r.next_due_mileage && vehicle.current_mileage) {
        mileageUntil = r.next_due_mileage - vehicle.current_mileage;
        if (mileageUntil <= 0) urgency = 'overdue';
        else if (mileageUntil <= 500) urgency = 'urgent';
      }

      return { ...r, vehicle, urgency, daysUntil, mileageUntil };
    })
    .filter(r => r && (r.urgency === 'overdue' || r.urgency === 'urgent'))
    .sort((a, b) => {
      if (a.urgency === 'overdue' && b.urgency !== 'overdue') return -1;
      if (b.urgency === 'overdue' && a.urgency !== 'overdue') return 1;
      return (a.daysUntil || 0) - (b.daysUntil || 0);
    })
    .slice(0, 10);

  const serviceTypeLabels = {
    oil_change: "Oil Change",
    tire_rotation: "Tire Rotation",
    brake_service: "Brake Service",
    inspection: "Inspection",
    registration: "Registration"
  };

  return (
    <Card className="border-0 shadow-sm">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-base">
          <Bell className="w-5 h-5 text-orange-600" />
          Upcoming Customer Reminders
        </CardTitle>
      </CardHeader>
      <CardContent>
        {enrichedReminders.length === 0 ? (
          <div className="text-center py-8 text-slate-500">
            <Bell className="w-8 h-8 mx-auto mb-2 opacity-50" />
            <p className="text-sm">No urgent reminders</p>
          </div>
        ) : (
          <div className="space-y-3">
            {enrichedReminders.map((reminder) => (
              <Link 
                key={reminder.id}
                to={createPageUrl(`MechanicVehicleDetail?id=${reminder.vehicle_id}`)}
                className="block"
              >
                <div className="p-3 rounded-lg border hover:border-orange-300 hover:bg-orange-50/50 transition-all">
                  <div className="flex items-start justify-between gap-2">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        {reminder.urgency === 'overdue' && (
                          <AlertTriangle className="w-4 h-4 text-red-500 flex-shrink-0" />
                        )}
                        <p className="font-medium text-sm truncate">
                          {reminder.vehicle.year} {reminder.vehicle.make} {reminder.vehicle.model}
                        </p>
                      </div>
                      <p className="text-xs text-slate-600 mb-2">
                        {reminder.custom_title || serviceTypeLabels[reminder.service_type] || reminder.service_type}
                      </p>
                      <div className="flex flex-wrap items-center gap-3 text-xs text-slate-500">
                        {reminder.next_due_date && (
                          <span className="flex items-center gap-1">
                            <Calendar className="w-3 h-3" />
                            {format(new Date(reminder.next_due_date), 'MMM d')}
                            {reminder.daysUntil !== null && (
                              <span className={reminder.daysUntil < 0 ? 'text-red-600' : ''}>
                                ({reminder.daysUntil < 0 ? `${Math.abs(reminder.daysUntil)}d overdue` : `${reminder.daysUntil}d`})
                              </span>
                            )}
                          </span>
                        )}
                        {reminder.next_due_mileage && (
                          <span className="flex items-center gap-1">
                            <Gauge className="w-3 h-3" />
                            {reminder.next_due_mileage.toLocaleString()}
                            {reminder.mileageUntil !== null && (
                              <span className={reminder.mileageUntil < 0 ? 'text-red-600' : ''}>
                                ({reminder.mileageUntil < 0 ? 'overdue' : `${reminder.mileageUntil} left`})
                              </span>
                            )}
                          </span>
                        )}
                      </div>
                    </div>
                    <Badge 
                      variant="secondary" 
                      className={reminder.urgency === 'overdue' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700'}
                    >
                      {reminder.urgency === 'overdue' ? 'Overdue' : 'Due Soon'}
                    </Badge>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}